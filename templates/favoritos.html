<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Favoritos de {{ user['name'] or user['username'] }}</title>
    <link rel="stylesheet" href="/static/css/perfil.css">
    <link rel="stylesheet" href="/static/css/favoritos.css">
</head>
<body>
    <a href="/" class="home-btn" title="Voltar para a página inicial">
        <span class="home-icon">
            <svg width="26" height="26" viewBox="0 0 24 24" fill="none">
                <path d="M3 11.5L12 4L21 11.5" stroke="#fff" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M5 10.5V20H19V10.5" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                <rect x="9" y="15" width="6" height="5" rx="1.5" fill="#fff" opacity="0.7"></rect>
            </svg>
        </span>
    </a>
    <div class="favoritos-header">
        <a href="/profile?id={{ user['user_id'] }}">
            <img src="{% if user['profile_picture'] %}/imagem/{{ user['profile_picture'] }}{% else %}/static/default_avatar.png{% endif %}" alt="Foto de perfil" class="favoritos-avatar">
        </a>
        <div class="favoritos-username">{{ user['name'] or user['username'] }}</div>
    </div>

    <div class="favoritos-catalogo">
        {% if favoritos %}
            {% for fav in favoritos %}
                <div class="favorito-card" data-id="{{ fav['game_id'] }}">
                    <img src="{{ fav['game_image'] }}" alt="{{ fav['game_name'] }}" class="favorito-img">
                    <div class="favorito-title">{{ fav['game_name'] }}</div>
                    {% if logged_user and user['user_id'] == logged_user['user_id'] %}
                        <button class="fav-btn" data-id="{{ fav['game_id'] }}">Desfavoritar ⭐</button>
                    {% else %}
                        {% set ja_favoritado = False %}
                        {% if logged_user %}
                            {% for f in logged_user.get('favorites', []) %}
                                {% if (f['game_id'] if f is mapping else f) == fav['game_id'] %}
                                    {% set ja_favoritado = True %}
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                        {% if ja_favoritado %}
                            <button class="fav-btn favorited" data-id="{{ fav['game_id'] }}" disabled>Favoritado ⭐</button>
                        {% else %}
                            <button class="fav-btn" data-id="{{ fav['game_id'] }}">Favoritar ⭐</button>
                        {% endif %}
                    {% endif %}
                </div>
            {% endfor %}
        {% else %}
            <span style="color:#c7d5e0;">Nenhum favorito ainda.</span>
        {% endif %}
    </div>

    <!-- Paginação -->
    {% if total > per_page %}
    <div class="favoritos-pagination">
        {% for p in range(1, (total // per_page) + (1 if total % per_page else 0) + 1) %}
            {% if p == page %}
                <span class="favoritos-page atual">{{ p }}</span>
            {% else %}
                <a class="favoritos-page" href="{{ url_for('favoritos', user_id=user['user_id'], page=p) }}">{{ p }}</a>
            {% endif %}
        {% endfor %}
    </div>
    {% endif %}

    <!-- Amigos (opcional) -->
    {% if amigos %}
    <div class="favoritos-amigos">
        <h4>Ver favoritos dos amigos:</h4>
        {% for amigo in amigos %}
            <a href="{{ url_for('favoritos', user_id=amigo['user_id']) }}" class="favoritos-amigo-link">
                <img src="{% if amigo['profile_picture'] %}/imagem/{{ amigo['profile_picture'] }}{% else %}/static/default_avatar.png{% endif %}" alt="{{ amigo['name'] or amigo['username'] }}" class="favoritos-amigo-avatar">
                <span>{{ amigo['name'] or amigo['username'] }}</span>
            </a>
        {% endfor %}
    </div>
    {% endif %}

    <script>
    document.querySelectorAll('.fav-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const gameId = btn.dataset.id;
            // Pega o nome e imagem do jogo do card
            const card = btn.closest('.favorito-card');
            const gameName = card.querySelector('.favorito-title')?.textContent || '';
            const gameImage = card.querySelector('.favorito-img')?.getAttribute('src') || '';
            fetch('/favorite', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ game_id: gameId, game_name: gameName, game_image: gameImage })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success && data.action === "removed") {
                    // Remove o card correto na página de favoritos
                    if (btn.textContent.includes('Desfavoritar')) {
                        if (card) card.remove();
                    } else {
                        // Se for em perfil de amigo, só muda o botão
                        btn.textContent = "Favoritar ⭐";
                        btn.classList.remove('favorited');
                        btn.disabled = false;
                    }
                } else if (data.success && data.action === "added") {
                    btn.textContent = "Favoritado ⭐";
                    btn.classList.add('favorited');
                    btn.disabled = true;
                }
            });
        });
    });
    </script>
</body>
</html>